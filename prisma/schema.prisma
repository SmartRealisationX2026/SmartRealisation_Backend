// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum UserRole {
  PATIENT
  PHARMACIST
  ADMIN
}

enum AlertStatus {
  ACTIVE
  TRIGGERED
  EXPIRED
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
}

enum Language {
  FR
  EN
}

enum ActionType {
  CREATE
  UPDATE
  DELETE
}

// Models
model User {
  id             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid()
  email          String     @unique
  passwordHash   String     @map("password_hash")
  role           UserRole
  fullName       String     @map("full_name")
  phone          String?
  preferredLanguage Language @default(FR) @map("preferred_language")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  isActive       Boolean    @default(true) @map("is_active")

  // Relations
  ownedPharmacies    Pharmacy[]       @relation("Owner")
  searches           Search[]
  stockAlerts        StockAlert[]     @relation("UserStockAlerts")
  systemAuditLogs    SystemAuditLog[]
  priceHistory       PriceHistory[]   @relation("ChangedBy")

  // Indexes
  @@index([email])
  @@index([role])
  @@map("users")
}

model Address {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid()
  cityId     String   @map("city_id") @db.Uuid()
  districtId String?  @map("district_id") @db.Uuid()
  streetAddress String @map("street_address")
  landmark   String?
  postalCode String?  @map("postal_code")
  latitude   Decimal  @db.Decimal(10, 8)
  longitude  Decimal  @db.Decimal(11, 8)

  // Relations
  city     City      @relation(fields: [cityId], references: [id])
  district District? @relation(fields: [districtId], references: [id])
  pharmacy Pharmacy?

  // Indexes
  @@index([latitude, longitude])
  @@index([cityId, districtId])
  @@map("addresses")
}

model City {
  id      String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid()
  nameFr  String     @map("name_fr")
  nameEn  String     @map("name_en")
  region  String

  // Relations
  addresses Address[]
  districts District[]

  // Indexes
  @@index([region])
  @@map("cities")
}

model District {
  id      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid()
  cityId  String   @map("city_id") @db.Uuid()
  nameFr  String   @map("name_fr")
  nameEn  String   @map("name_en")

  // Relations
  city      City      @relation(fields: [cityId], references: [id], onDelete: Cascade)
  addresses Address[]

  // Indexes
  @@index([cityId])
  @@map("districts")
}

model Category {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid()
  code        String   @unique
  nameFr      String   @map("name_fr")
  nameEn      String   @map("name_en")
  description String?
  level       Int      @default(1)
  parentId    String?  @map("parent_id") @db.Uuid()

  // Relations
  parent   Category?   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[]  @relation("CategoryHierarchy")
  medications Medication[]

  // Indexes
  @@index([parentId])
  @@index([level])
  @@map("categories")
}

model MedicationForm {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid()
  code        String   @unique
  nameFr      String   @map("name_fr")
  nameEn      String   @map("name_en")
  description String?

  // Relations
  medications Medication[]

  @@map("medication_forms")
}

model Medication {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid()
  commercialName    String          @map("commercial_name")
  dciName           String?         @map("dci_name")
  categoryId        String          @map("category_id") @db.Uuid()
  formId            String          @map("form_id") @db.Uuid()
  dosageStrength    String          @map("dosage_strength")
  dosageUnit        String          @map("dosage_unit")
  requiresPrescription Boolean       @default(false) @map("requires_prescription")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  category     Category       @relation(fields: [categoryId], references: [id])
  form         MedicationForm @relation(fields: [formId], references: [id])
  inventoryItems InventoryItem[]
  searches     Search[]
  stockAlerts  StockAlert[]

  // Indexes
  @@index([commercialName])
  @@index([dciName])
  @@index([categoryId])
  @@map("medications")
}

model Pharmacy {
  id                String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid()
  name              String
  addressId         String      @unique @map("address_id") @db.Uuid()
  licenseNumber     String?     @map("license_number")
  phone             String?
  emergencyPhone    String?     @map("emergency_phone")
  is24_7            Boolean     @default(false) @map("is_24_7")
  openingTime       DateTime?   @map("opening_time") @db.Time
  closingTime       DateTime?   @map("closing_time") @db.Time
  workingDays       Json        @map("working_days") // [1,2,3,4,5,6,7]
  ownerId           String      @map("owner_id") @db.Uuid()
  isVerified        Boolean     @default(false) @map("is_verified")
  verifiedAt        DateTime?   @map("verified_at")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relations
  address      Address         @relation(fields: [addressId], references: [id])
  owner        User            @relation("Owner", fields: [ownerId], references: [id], onDelete: Cascade)
  inventoryItems InventoryItem[]
  stockAlerts  StockAlert[]

  // Indexes
  @@index([addressId])
  @@index([ownerId])
  @@index([isVerified])
  @@map("pharmacies")
}

model InventoryItem {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid()
  pharmacyId       String      @map("pharmacy_id") @db.Uuid()
  medicationId     String      @map("medication_id") @db.Uuid()
  batchNumber      String      @map("batch_number")
  expirationDate   DateTime    @map("expiration_date") @db.Date
  quantityInStock  Int         @map("quantity_in_stock")
  unitPriceFcfa    Decimal     @map("unit_price_fcfa") @db.Decimal(10, 2)
  sellingPriceFcfa Decimal     @map("selling_price_fcfa") @db.Decimal(10, 2)
  isAvailable      Boolean     @default(true) @map("is_available")
  lastRestocked    DateTime?   @map("last_restocked")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  // Relations
  pharmacy   Pharmacy     @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  medication Medication   @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  priceHistory PriceHistory[]

  // Constraints
  @@unique([pharmacyId, medicationId, batchNumber])
  // Indexes
  @@index([quantityInStock])
  @@index([expirationDate])
  @@index([unitPriceFcfa])
  @@index([sellingPriceFcfa])
  @@index([pharmacyId, medicationId])
  @@map("inventory_items")
}

model Search {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid()
  userId         String?  @map("user_id") @db.Uuid()
  medicationId   String   @map("medication_id") @db.Uuid()
  latitude       Decimal  @db.Decimal(10, 8)
  longitude      Decimal  @db.Decimal(11, 8)
  radiusKm       Int?     @map("radius_km")
  filtersApplied Json?    @map("filters_applied")
  resultsFound   Int      @default(0) @map("results_found")
  searchedAt     DateTime @default(now()) @map("searched_at")

  // Relations
  user       User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  medication Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([latitude, longitude])
  @@index([searchedAt])
  @@map("searches")
}

model PriceHistory {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid()
  inventoryItemId String   @map("inventory_item_id") @db.Uuid()
  oldPriceFcfa    Decimal  @map("old_price_fcfa") @db.Decimal(10, 2)
  newPriceFcfa    Decimal  @map("new_price_fcfa") @db.Decimal(10, 2)
  changedAt       DateTime @default(now()) @map("changed_at")
  changedBy       String   @map("changed_by") @db.Uuid()

  // Relations
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  user          User          @relation("ChangedBy", fields: [changedBy], references: [id])

  // Indexes
  @@index([inventoryItemId])
  @@index([changedAt])
  @@map("price_history")
}

model StockAlert {
  id                 String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid()
  userId             String?            @map("user_id") @db.Uuid()
  medicationId       String             @map("medication_id") @db.Uuid()
  pharmacyId         String?            @map("pharmacy_id") @db.Uuid()
  notificationChannel NotificationChannel @map("notification_channel")
  contactInfo        String             @map("contact_info")
  status             AlertStatus        @default(ACTIVE)
  createdAt          DateTime           @default(now()) @map("created_at")
  triggeredAt        DateTime?          @map("triggered_at")
  expiresAt          DateTime?          @map("expires_at")

  // Relations
  user       User?       @relation("UserStockAlerts", fields: [userId], references: [id], onDelete: SetNull)
  medication Medication  @relation(fields: [medicationId], references: [id], onDelete: Cascade)
  pharmacy   Pharmacy?   @relation(fields: [pharmacyId], references: [id], onDelete: SetNull)

  @@map("stock_alerts")
}

model AdminAnalytics {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid()
  analyticsDate      DateTime @map("analytics_date") @db.Date
  totalSearches      Int      @map("total_searches")
  successfulSearches Int      @map("successful_searches")
  newUsers           Int      @map("new_users")
  activePharmacies   Int      @map("active_pharmacies")
  topMedications     Json?    @map("top_medications")
  searchHeatmap      Json?    @map("search_heatmap")
  generatedAt        DateTime @default(now()) @map("generated_at")

  // Indexes
  @@index([analyticsDate])
  @@map("admin_analytics")
}

model SystemAuditLog {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid()
  userId     String     @map("user_id") @db.Uuid()
  actionType ActionType @map("action_type")
  entityType String     @map("entity_type")
  entityId   String     @map("entity_id")
  oldValues  Json?      @map("old_values")
  newValues  Json?      @map("new_values")
  ipAddress  String?    @map("ip_address")
  createdAt  DateTime   @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([actionType])
  @@index([entityType])
  @@index([createdAt])
  @@map("system_audit_logs")
}
